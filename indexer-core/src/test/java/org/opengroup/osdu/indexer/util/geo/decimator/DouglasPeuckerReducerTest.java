/*
 * Copyright Â© Schlumberger
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.opengroup.osdu.indexer.util.geo.decimator;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import org.junit.Assert;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.opengroup.osdu.indexer.model.geojson.Position;
import org.springframework.test.context.junit4.SpringRunner;

import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.List;

@RunWith(SpringRunner.class)
public class DouglasPeuckerReducerTest {
    Gson gson = new Gson();

    @InjectMocks
    private DouglasPeuckerReducer sut;

    @Test
    public void should_decimate_line() {
        String coordinatesJson = "[[178.11226380138962, -36.390207464157314], [178.1123772202456, -36.39023861556822], [178.11251344088177, -36.3902777929863], [178.11264907210185, -36.390307990851994], [178.11278588251707, -36.39035614732104], [178.11291040784653, -36.39038682152853], [178.11304662894693, -36.390425998293146], [178.11318226056676, -36.39045619551308], [178.11329685929155, -36.39050530474071], [178.11343249111647, -36.39053550165624], [178.11356871267787, -36.39057467778047], [178.113693828242, -36.39061433048508], [178.11383005004217, -36.39065350628816], [178.11396568226678, -36.39068370255791], [178.11407969203833, -36.390723831598926], [178.11421591417854, -36.39076300692875], [178.7285555264073, -36.68661856799342], [178.72867223805497, -36.68668495001179]]";
        List<Position> coordinates = convertToPositionList(coordinatesJson);
        List<Integer> indexes = sut.getPointIndexesToKeep(coordinates, 100000, 10);
        Assert.assertTrue(coordinates.size() > indexes.size());
        // First and last points should be kept
        Assert.assertTrue(indexes.get(0) == 0);
        Assert.assertTrue(indexes.get(indexes.size() -1) == coordinates.size() -1);
    }

    @Test
    public void should_decimate_polygon() {
        String coordinatesJson = "[[104.07197000000014, 5.092352000000005], [104.17093500000004, 4.912466999999992], [104.1873700000001, 4.921559000000002], [104.18752300000011, 4.921515000000056], [104.35131699999994, 5.01209700000004], [104.35192899999998, 5.011919000000091], [104.35202800000002, 5.011974000000009], [104.35248800000005, 5.01184000000012], [104.35258599999997, 5.011895000000038], [104.35319900000007, 5.01171700000009], [104.35329800000011, 5.011772000000008], [104.35375700000003, 5.011639000000002], [104.35385600000006, 5.011693000000037], [104.35431599999993, 5.011560000000031], [104.35441500000013, 5.0116140000000655], [104.35502699999995, 5.011437000000001], [104.35512599999998, 5.011491000000035], [104.35558600000002, 5.01135800000003], [104.355684, 5.011413000000118], [104.3562970000001, 5.011234999999999], [104.35639600000007, 5.011288999999977], [104.35685500000005, 5.011156000000028], [104.35695400000009, 5.011211000000117], [104.35756700000002, 5.011032999999941], [104.35766500000011, 5.011088000000086], [104.35812499999997, 5.01095399999997], [104.358224, 5.011009000000115], [104.35868299999998, 5.0108750000000555], [104.35878199999996, 5.0109299999999735], [104.35939500000006, 5.010752000000139], [104.3594940000001, 5.0108070000001135], [104.35995300000008, 5.010674000000108], [104.36005200000005, 5.010727999999972], [104.36066499999998, 5.010550000000137], [104.36076300000013, 5.010605000000055], [104.361223, 5.010472000000107], [104.36132199999997, 5.010526000000084], [104.36178099999995, 5.0103930000001355], [104.36187999999999, 5.0104480000000535], [104.36249300000009, 5.010270000000048], [104.36259100000001, 5.010324000000082], [104.36305100000004, 5.010191000000077], [104.36315000000008, 5.010246000000052], [104.36376200000007, 5.010068000000047], [104.3638610000001, 5.010122999999965], [104.36432099999996, 5.0099890000000755], [104.36441900000011, 5.0100439999999935], [104.36503199999999, 5.009866000000045], [104.36513100000002, 5.0099210000001335], [104.36559, 5.009787000000074], [104.36568900000003, 5.009841999999992], [104.36614900000006, 5.009708999999987], [104.36624699999999, 5.009763000000021], [104.36686000000009, 5.009585000000072], [104.36695900000012, 5.00963999999999], [104.3674180000001, 5.009506999999985], [104.36751700000008, 5.009561000000019], [104.36813000000001, 5.009383000000014], [104.36822900000004, 5.009437999999989], [104.36868800000002, 5.0093049999999835], [104.368787, 5.009359000000018], [104.3694000000001, 5.0091820000001235], [104.36949800000002, 5.00923599999993], [104.36995800000011, 5.009102999999982], [104.37005699999992, 5.009157000000016], [104.37051600000007, 5.009024000000011], [104.3706150000001, 5.009079000000099], [104.37122800000003, 5.008900999999923], [104.37132600000012, 5.008956000000069], [104.37178599999999, 5.008822000000009], [104.37188500000002, 5.008877000000098], [104.37249700000001, 5.008699000000092], [104.37259600000004, 5.008754000000067], [104.37305600000008, 5.008619999999951], [104.37315400000006, 5.008675000000096], [104.37376699999993, 5.008497000000091], [104.37386600000013, 5.008552000000009], [104.37432500000011, 5.00841800000012], [104.37442399999998, 5.008473000000038], [104.37488400000001, 5.008340000000089], [104.3749820000001, 5.0083940000001235], [104.37559500000003, 5.008216000000118], [104.37569400000007, 5.008271000000036], [104.37615299999999, 5.008138000000031], [104.37625200000002, 5.008192000000065], [104.37686500000012, 5.008015], [104.37696399999999, 5.0080690000000345], [104.37742300000014, 5.007936000000029], [104.37752199999994, 5.0079900000000634], [104.37813500000004, 5.007812999999999], [104.37823299999997, 5.007867000000033], [104.37869300000006, 5.007734000000028], [104.37879200000003, 5.007788000000062], [104.37925100000001, 5.007655000000057], [104.37935000000004, 5.007709999999975], [104.37996299999998, 5.007532000000026], [104.38006100000007, 5.007587000000115], [104.3805210000001, 5.007453000000055], [104.38062000000014, 5.007507999999973], [104.38123199999995, 5.007329999999968], [104.38133099999999, 5.007385000000113], [104.38179100000002, 5.007251000000053], [104.38188899999994, 5.007306000000142], [104.38250200000004, 5.007128000000137], [104.38260100000008, 5.007183000000111], [104.38306000000006, 5.007048999999995], [104.38315900000009, 5.00710400000014], [104.38361900000012, 5.006971000000135], [104.38371700000005, 5.007024999999999], [104.38432999999998, 5.006846999999993], [104.38442900000001, 5.006902000000082], [104.38488799999993, 5.0067690000001335], [104.38498700000014, 5.00682299999994], [104.38560000000007, 5.006644999999992], [104.3856990000001, 5.00670000000008], [104.38615800000002, 5.006567000000075], [104.38625700000006, 5.006621000000109], [104.38686999999999, 5.0064440000000445], [104.38696800000008, 5.006498000000079], [104.38742799999994, 5.0063650000000735], [104.38752699999998, 5.006419000000108], [104.38798600000013, 5.006286000000102], [104.38808499999999, 5.006341000000077], [104.38869800000009, 5.006163000000072], [104.38879600000001, 5.006217000000106], [104.38925600000005, 5.006084000000101], [104.38935500000008, 5.006139000000019], [104.38996700000007, 5.00596100000007], [104.3900660000001, 5.006015999999988], [104.39052600000014, 5.005882000000099], [104.39062400000006, 5.005937000000017], [104.39123699999999, 5.005759000000012], [104.39133600000002, 5.005813999999987], [104.391795, 5.005680000000098], [104.39189399999998, 5.005735000000016], [104.39235400000007, 5.0056010000001265], [104.39245199999999, 5.0056560000000445], [104.39306500000009, 5.005478000000039], [104.39316400000013, 5.005533000000014], [104.39362300000005, 5.005400000000009], [104.39372200000008, 5.005454000000043], [104.39433500000001, 5.005276000000038], [104.39443400000005, 5.005330999999956], [104.39489299999997, 5.005198000000007], [104.394992, 5.0052519999999845], [104.3956050000001, 5.005074000000036], [104.39570300000003, 5.0051290000001245], [104.39616300000006, 5.004995999999949], [104.39626200000009, 5.005049999999983], [104.39672100000007, 5.004916999999978], [104.3968200000001, 5.004971000000012], [104.39743299999998, 5.004794000000118], [104.39753100000013, 5.004847999999981], [104.39799099999999, 5.004714999999976], [104.39809000000002, 5.00476900000001], [104.39870200000001, 5.004592000000116], [104.39880100000005, 5.00464599999998], [104.39926100000008, 5.0045129999999745], [104.399359, 5.004568000000063], [104.3999720000001, 5.0043900000001145], [104.40007100000014, 5.004443999999921], [104.40053000000012, 5.004310999999973], [104.40062899999992, 5.004366000000061], [104.40108900000001, 5.004232000000002], [104.4011870000001, 5.00428700000009], [104.40180000000004, 5.004109000000142], [104.40189900000001, 5.00416400000006], [104.40235799999999, 5.00403], [104.40245700000003, 5.004085000000089], [104.40307000000013, 5.003907000000083], [104.40316899999993, 5.003962000000058], [104.40362800000008, 5.003827999999942], [104.40372700000012, 5.003883000000087], [104.40434000000005, 5.003705000000082], [104.40443800000014, 5.00376], [104.404898, 5.003626000000111], [104.40499700000004, 5.003681000000029], [104.40545600000002, 5.00354800000008], [104.40555500000005, 5.0036020000001145], [104.40616799999992, 5.003424000000109], [104.40626600000007, 5.003479000000027], [104.4067260000001, 5.003346000000022], [104.40682500000014, 5.003400000000056], [104.40743700000013, 5.0032220000001075], [104.407536, 5.0032770000000255], [104.40799600000003, 5.00314400000002], [104.40809399999995, 5.003198000000054], [104.40855399999998, 5.003065000000049], [104.40865300000002, 5.003119000000083], [104.40895899999992, 5.003030000000024], [104.40905800000013, 5.003085000000112], [104.40951700000011, 5.002951999999937], [104.40961600000014, 5.003006000000141], [104.40992200000005, 5.002917000000082], [104.41002100000009, 5.002972], [104.41048100000012, 5.0028389999999945], [104.41057900000004, 5.002893000000029], [104.41088600000006, 5.00280400000014], [104.41098399999998, 5.002859000000058], [104.41144400000002, 5.002726000000109], [104.41154300000005, 5.002779999999916], [104.41184900000013, 5.002691000000027], [104.411948, 5.002745999999945], [104.41240699999997, 5.002612000000056], [104.41250599999995, 5.002666999999974], [104.41281200000009, 5.002578000000085], [104.41291100000007, 5.002633000000003], [104.41337099999993, 5.002499000000114], [104.41346999999996, 5.002554000000089], [104.41377600000004, 5.002464999999972], [104.41387500000008, 5.002520000000118], [104.41433400000005, 5.002386000000001], [104.41443300000009, 5.002440999999976], [104.414739, 5.00235200000003], [104.41483800000003, 5.002407000000005], [104.41529800000006, 5.002273000000059], [104.41539599999999, 5.002328000000034], [104.41570300000001, 5.002238999999918], [104.4158010000001, 5.0022930000001224], [104.41626099999996, 5.002159999999947], [104.41636, 5.002215000000092], [104.41666600000008, 5.002125999999976], [104.41676500000011, 5.00218000000001], [104.41722400000009, 5.002047000000061], [104.41732300000007, 5.002101999999979], [104.41762900000003, 5.00201300000009], [104.41772800000001, 5.002067000000068], [104.4181880000001, 5.001934000000119], [104.41828600000002, 5.001987999999926], [104.41859299999999, 5.001899999999978], [104.41869100000014, 5.001953999999955], [104.419151, 5.001821000000007], [104.41925000000003, 5.001875000000041], [104.41955600000011, 5.001786000000095], [104.41965499999998, 5.00184100000007], [104.42011400000007, 5.001708000000065], [104.4202130000001, 5.001762000000099], [104.42051900000001, 5.0016729999999825], [104.42061800000005, 5.001728000000128], [104.42107800000008, 5.001595000000123], [104.42117700000011, 5.001648999999986], [104.42148300000002, 5.00156000000004], [104.42158200000006, 5.001615000000015], [104.42204100000004, 5.001481000000126], [104.42214000000001, 5.001536000000044], [104.42244599999998, 5.001446999999928], [104.42254499999996, 5.001502000000073], [104.42300500000005, 5.001368000000014], [104.42310300000014, 5.001423000000102], [104.42340999999993, 5.001334000000043], [104.42350800000008, 5.001389000000131], [104.42396800000012, 5.0012550000000715], [104.42406699999998, 5.0013099999999895], [104.42437300000006, 5.0012210000001005], [104.4244720000001, 5.001275000000135], [104.42493100000002, 5.001142000000129], [104.42503000000005, 5.001197000000047], [104.42533599999996, 5.001107999999988], [104.425435, 5.001162000000022], [104.42589500000003, 5.001029000000017], [104.425993, 5.001084000000105], [104.42629999999997, 5.000995000000046], [104.426399, 5.00104900000008], [104.42685799999998, 5.000916000000075], [104.42695699999996, 5.000970000000109], [104.42741599999994, 5.000837000000104], [104.42751500000014, 5.000892000000022], [104.42782100000005, 5.000803000000133], [104.42792000000009, 5.000856999999996], [104.42838000000012, 5.000723999999991], [104.42847800000004, 5.00077900000008], [104.42878500000006, 5.00069000000002], [104.4288840000001, 5.000744000000054], [104.42934300000007, 5.000611000000049], [104.42944200000005, 5.000665000000083], [104.42974799999996, 5.000577000000078], [104.429847, 5.000631000000112], [104.43030599999997, 5.000498000000107], [104.43040500000001, 5.000552000000141], [104.43071199999997, 5.000463000000082], [104.43081000000012, 5.000518], [104.43126999999998, 5.000384999999994], [104.43136900000002, 5.0004390000000285], [104.4316750000001, 5.0003500000001395], [104.43177400000013, 5.0004050000000575], [104.43223300000005, 5.000272000000052], [104.43233200000009, 5.000326000000086], [104.432638, 5.000237000000027], [104.43273700000003, 5.000292000000115], [104.43319700000006, 5.000158000000056], [104.43329499999999, 5.000212999999974], [104.43360200000001, 5.000124000000085], [104.43369999999993, 5.000179000000003], [104.43416000000002, 5.000045000000114], [104.434259, 5.000100000000032], [104.43456500000013, 5.000010999999972], [104.43466399999994, 5.000066000000061], [104.43512300000009, 4.999932000000001], [104.43522200000012, 4.999986999999919], [104.43552800000003, 4.99989800000003], [104.43562700000007, 4.999952000000064], [104.4360870000001, 4.999819000000059], [104.43618500000002, 4.999874000000034], [104.43649200000004, 4.999785000000088], [104.43659100000008, 4.999839000000122], [104.43705, 4.9997059999999465], [104.43714900000003, 4.999761000000092], [104.43745499999994, 4.9996719999999755], [104.43755399999998, 4.99972600000001], [104.43801300000013, 4.999593000000004], [104.43811199999993, 4.999647000000039], [104.43841900000012, 4.999557999999979], [104.43851700000005, 4.999613000000068], [104.43897700000014, 4.999480000000119], [104.43907599999994, 4.999533999999926], [104.43938200000008, 4.999445000000037], [104.43948100000006, 4.999499999999955], [104.43994000000004, 4.9993670000000066], [104.44003900000007, 4.999420999999984], [104.44034499999998, 4.999332000000095], [104.44044400000001, 4.999387000000013], [104.44090400000005, 4.999253000000124], [104.44100199999997, 4.999308000000099], [104.44130899999999, 4.999218999999982], [104.44140700000008, 4.999274000000128], [104.44186699999995, 4.999140000000011], [104.44196599999998, 4.999194999999986], [104.44227200000006, 4.99910600000004], [104.4423710000001, 4.999161000000015], [104.44283000000007, 4.999027000000069], [104.4429290000001, 4.999082000000044], [104.44323500000002, 4.998992999999928], [104.443334, 4.999047000000132], [104.44379400000008, 4.998913999999957], [104.443892, 4.998969000000102], [104.44419900000003, 4.998879999999986], [104.444298, 4.99893400000002], [104.44475699999998, 4.998801000000071], [104.44485600000002, 4.998855000000049], [104.445315, 4.9987220000001], [104.44541399999997, 4.998777000000018], [104.44572000000011, 4.998688000000129], [104.44581899999991, 4.998741999999936], [104.44627899999995, 4.998608999999988], [104.4463770000001, 4.998663000000022], [104.44668400000006, 4.998575000000017], [104.4467830000001, 4.998629000000051], [104.44724200000007, 4.998496000000046], [104.44734100000011, 4.99855000000008], [104.44764700000002, 4.998460999999963], [104.44774600000005, 4.998516000000109], [104.44820499999997, 4.9983830000001035], [104.44830400000001, 4.998437000000138], [104.44861100000003, 4.998348000000021], [104.44870900000012, 4.998402999999996], [104.44916899999998, 4.998269000000107], [104.44926800000002, 4.998324000000025], [104.4495740000001, 4.998235000000136], [104.44967300000013, 4.998290000000054], [104.45013200000011, 4.9981559999999945], [104.45023099999992, 4.998211000000083], [104.45053700000005, 4.9981220000000235], [104.45063600000003, 4.998177000000112], [104.45109600000012, 4.998043000000052], [104.45119400000004, 4.998098000000141], [104.45150100000001, 4.998009000000081], [104.45159899999999, 4.998063000000116], [104.45205900000002, 4.99793000000011], [104.45215800000005, 4.997985000000028], [104.45246400000013, 4.997896000000139], [104.452563, 4.997950000000003], [104.45302199999992, 4.997816999999998], [104.45312100000012, 4.997871000000032], [104.45342700000003, 4.997783000000027], [104.45352600000007, 4.997837000000061], [104.45398599999993, 4.997704000000056], [104.45408400000008, 4.99775800000009], [104.45439100000004, 4.9976689999999735], [104.45449000000008, 4.997724000000119], [104.45494900000006, 4.997591000000114], [104.45504800000003, 4.997644999999977], [104.455354, 4.997556000000088], [104.45545299999998, 4.997611000000006], [104.45591200000013, 4.997477000000117], [104.45601099999999, 4.997532000000035], [104.45631799999995, 4.997442999999976], [104.4564160000001, 4.997498000000064], [104.45687600000014, 4.997364000000005], [104.456975, 4.997419000000093], [104.45728100000008, 4.997330000000034], [104.45738000000011, 4.997384000000068], [104.45783900000004, 4.9972510000000625], [104.45793800000007, 4.9973059999999805], [104.45824399999998, 4.9972170000000915], [104.45834300000001, 4.997271000000126], [104.45880300000005, 4.99713800000012], [104.45890100000003, 4.997193000000038], [104.45920799999999, 4.997103999999979], [104.45930600000014, 4.997158000000013], [104.459766, 4.997025000000008], [104.45986499999998, 4.997079000000042], [104.46017100000012, 4.996989999999926], [104.46026999999992, 4.997045000000071], [104.46072900000007, 4.996912000000066], [104.4608280000001, 4.9969660000001], [104.46113400000002, 4.99687700000004], [104.46123300000005, 4.996932000000129], [104.46169300000008, 4.996798000000069], [104.461791, 4.996852999999987], [104.46209800000003, 4.996764000000098], [104.46219599999995, 4.996819000000016], [104.46265599999998, 4.996685000000127], [104.46275500000002, 4.996740000000045], [104.46306099999993, 4.996650999999986], [104.46316000000013, 4.996706000000074], [104.46361900000011, 4.996572000000015], [104.46371799999997, 4.996627000000103], [104.464178, 4.996493000000044], [104.4642760000001, 4.996548000000132], [104.46458300000012, 4.996459000000073], [104.46468100000004, 4.996513999999991], [104.46514100000007, 4.9963800000001015], [104.46524000000011, 4.9964350000000195], [104.46554600000002, 4.9963460000001305], [104.46564500000005, 4.996399999999994], [104.46610400000003, 4.996266999999989], [104.46620300000001, 4.996322000000077], [104.46650899999997, 4.996233000000018], [104.46660799999995, 4.996287000000052], [104.46706800000004, 4.996154000000047], [104.46716600000013, 4.996208000000081], [104.46747299999993, 4.9961190000000215], [104.46757199999996, 4.99617400000011], [104.46803100000011, 4.996041000000105], [104.46812999999997, 4.996095000000139], [104.46843600000005, 4.996006000000079], [104.46853500000009, 4.996060999999997], [104.46899400000001, 4.995927000000108], [104.46909300000004, 4.995982000000026], [104.46940000000006, 4.995893000000137], [104.46949799999999, 4.995948000000055], [104.46995800000002, 4.995813999999996], [104.47005700000005, 4.995869000000084], [104.47036299999996, 4.995780000000025], [104.470462, 4.995834000000059], [104.470846, 4.995723000000112], [104.664763, 4.642563999999936], [104.54274900000007, 4.575139000000036], [104.52483399999994, 4.6077770000000555], [104.5246810000001, 4.607821000000001], [104.46777100000008, 4.71147000000002], [104.31073500000002, 4.624635000000126], [104.27126200000004, 4.696478000000013], [104.27130599999992, 4.6966319999999655], [104.21669300000013, 4.795995000000005], [103.93960600000003, 4.642623000000015], [103.78080699999992, 4.931140000000141], [104.07197000000014, 5.092352000000005]]";
        List<Position> coordinates = convertToPositionList(coordinatesJson);
        List<Integer> indexes = sut.getPointIndexesToKeep(coordinates, 100000, 10);
        Assert.assertTrue(coordinates.size() > indexes.size());
        // First and last points should be kept
        Assert.assertTrue(indexes.get(0) == 0);
        Assert.assertTrue(indexes.get(indexes.size() -1) == coordinates.size() -1);
    }

    @Test
    public void should_not_decimate_line_with_few_points() {
        String coordinatesJson = "[[178.11226380138962, -36.390207464157314], [178.1123772202456, -36.39023861556822], [178.11251344088177, -36.3902777929863], [178.7285555264073, -36.68661856799342], [178.72867223805497, -36.68668495001179]]";
        List<Position> coordinates = convertToPositionList(coordinatesJson);
        Assert.assertTrue(coordinates.size() < 6);
        List<Integer> indexes = sut.getPointIndexesToKeep(coordinates, 100000, 10);
        Assert.assertEquals(coordinates.size(), indexes.size());
    }

    private List<Position> convertToPositionList(String coordinatesJson) {
        Type listType = new TypeToken<List>() {}.getType();
        List<List<Double>> coordinates = gson.fromJson(coordinatesJson, listType);

        List<Position> positionList = new ArrayList<>();
        for (List<Double> xy : coordinates) {
            positionList.add(new Position(xy.get(0), xy.get(1)));
        }
        return positionList;
    }

}
